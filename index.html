<!DOCTYPE html>
<html lang="sv">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>L√∂phastighetsr√§knare + GAP</title>

    <style>
      :root {
        --bg: #0b0f19;
        --card: rgba(255, 255, 255, 0.06);
        --card2: rgba(255, 255, 255, 0.08);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.65);
        --line: rgba(255, 255, 255, 0.12);
        --focus: rgba(255, 255, 255, 0.18);
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        color: var(--text);
        background:
          radial-gradient(1200px 600px at 20% 10%, rgba(120, 100, 255, 0.25), transparent 55%),
          radial-gradient(900px 500px at 80% 20%, rgba(0, 200, 255, 0.18), transparent 60%),
          radial-gradient(900px 700px at 50% 90%, rgba(0, 255, 170, 0.12), transparent 65%),
          var(--bg);
        display: grid;
        place-items: center;
        padding: 22px;
      }

      .wrap { width: min(980px, 100%); }

      header {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 12px;
      }

      h1 {
        margin: 0;
        font-size: clamp(22px, 3vw, 32px);
        letter-spacing: -0.02em;
      }

      .sub {
        margin: 6px 0 0;
        font-size: 14px;
        color: var(--muted);
      }

      .pill {
        padding: 8px 12px;
        border: 1px solid var(--line);
        border-radius: 999px;
        font-size: 13px;
        color: var(--muted);
        background: rgba(255,255,255,0.04);
        height: fit-content;
        white-space: nowrap;
      }

      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
      }

      .tab {
        cursor: pointer;
        border: 1px solid var(--line);
        background: rgba(255,255,255,0.04);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        font-weight: 800;
        font-size: 13px;
      }

      .tab[aria-selected="true"] {
        background: var(--card2);
        border-color: rgba(255,255,255,0.18);
      }

      .card {
        border: 1px solid var(--line);
        background: var(--card);
        border-radius: 16px;
        padding: 14px;
        margin-bottom: 12px;
        backdrop-filter: blur(10px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.22);
      }

      .card h3 { margin: 0 0 6px; font-size: 14px; }
      .hint { margin: 0 0 10px; font-size: 13px; color: var(--muted); }

      label {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 4px;
        display: block;
      }

      input {
        width: 100%;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: rgba(0,0,0,0.18);
        color: var(--text);
        font-size: 15px;
        font-variant-numeric: tabular-nums;
      }

      input:focus {
        outline: none;
        border-color: var(--focus);
        box-shadow: 0 0 0 3px rgba(255,255,255,0.08);
      }

      .row5 {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
      }

      .row7 {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
      }

      .actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        flex-wrap: wrap;
      }

      button {
        padding: 8px 12px;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: var(--card2);
        color: var(--text);
        font-weight: 800;
        cursor: pointer;
      }

      .resultGrid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
      }

      .metric {
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 10px;
        background: rgba(255,255,255,0.05);
      }

      .metric h4 {
        margin: 0 0 4px;
        font-size: 12px;
        color: var(--muted);
      }

      .big {
        font-size: 22px;
        font-variant-numeric: tabular-nums;
      }

      .list {
        display: grid;
        gap: 6px;
      }

      .listRow {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        padding: 8px 10px;
        border: 1px solid var(--line);
        border-radius: 12px;
        background: rgba(255,255,255,0.04);
        font-size: 14px;
        font-variant-numeric: tabular-nums;
      }

      .status {
        margin-top: 8px;
        font-size: 12px;
        color: var(--muted);
      }

      .note {
        margin-top: 10px;
        font-size: 12px;
        color: var(--muted);
        line-height: 1.35;
      }

      .hidden { display: none; }

      @media (max-width: 980px) {
        .row5 { grid-template-columns: 1fr 1fr; }
        .row7 { grid-template-columns: 1fr 1fr; }
      }

      @media (max-width: 820px) {
        header { flex-direction: column; }
        .pill { white-space: normal; }
        .resultGrid { grid-template-columns: 1fr; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <header>
        <div>
          <h1>L√∂phastighetsr√§knare üèÉ‚Äç‚ôÇÔ∏è + GAP</h1>
          <p class="sub">
            Tempo kan matas i som <b>min/km</b>, <b>km/h</b> eller <b>mph</b> ‚Äî och synkas mellan flikarna.
          </p>
        </div>
        <div class="pill">Debounce 200ms ‚Ä¢ Tid: mm:ss / hh:mm:ss</div>
      </header>

      <div class="tabs" role="tablist" aria-label="Flikar">
        <button class="tab" id="tabCalc" role="tab" aria-selected="true" aria-controls="panelCalc" type="button">
          Tempo / distans / tid
        </button>
        <button class="tab" id="tabGap" role="tab" aria-selected="false" aria-controls="panelGap" type="button">
          GAP (lopp)
        </button>
      </div>

      <!-- PANEL 1 -->
      <section id="panelCalc" role="tabpanel" aria-labelledby="tabCalc">
        <div class="card">
          <h3>Inmatning</h3>
          <p class="hint">
            Du kan fylla i <b>tempo</b> (valfri enhet) + <b>distans</b> eller <b>tid</b>, eller <b>distans + tid</b>.
            Tempo-f√§lten konverteras direkt.
          </p>

          <div class="row5">
            <div>
              <label for="pace">Tempo (min/km)</label>
              <input id="pace" inputmode="text" placeholder="5:30" />
            </div>

            <div>
              <label for="kmh">Tempo (km/h)</label>
              <input id="kmh" inputmode="decimal" placeholder="10.9" />
            </div>

            <div>
              <label for="mph">Tempo (mph)</label>
              <input id="mph" inputmode="decimal" placeholder="6.8" />
            </div>

            <div>
              <label for="distance">Distans (km)</label>
              <input id="distance" inputmode="decimal" placeholder="10" />
            </div>

            <div>
              <label for="time">Tid</label>
              <input id="time" inputmode="text" placeholder="50:00" />
            </div>
          </div>

          <div class="actions">
            <button id="clearBtn" type="button">Rensa</button>
            <button id="demoBtn" type="button">Demo (5:30 + 10 km)</button>
          </div>

          <div class="status" id="statusCalc">B√∂rja med att skriva tempo (valfri enhet) eller distans + tid.</div>
        </div>

        <div class="card">
          <h3>Resultat</h3>

          <div class="resultGrid">
            <div class="metric">
              <h4>Hastighet</h4>
              <div class="big" id="outSpeed">‚Äî</div>
            </div>
            <div class="metric">
              <h4>Tempo</h4>
              <div class="big" id="outPace">‚Äî</div>
            </div>
          </div>

          <div class="list">
            <div class="listRow"><span>5 km</span><span id="t5k">‚Äî</span></div>
            <div class="listRow"><span>10 km</span><span id="t10k">‚Äî</span></div>
            <div class="listRow"><span>Halvmarathon</span><span id="thm">‚Äî</span></div>
            <div class="listRow"><span>Marathon</span><span id="tm">‚Äî</span></div>
          </div>

          <div class="status" id="outExtra">‚Äî</div>
        </div>
      </section>

      <!-- PANEL 2 -->
      <section id="panelGap" role="tabpanel" aria-labelledby="tabGap" class="hidden">
        <div class="card">
          <h3>GAP (Grade Adjusted Pace) ‚Äî input</h3>
          <p class="hint">
            Variant B: <b>Distans + (Tid eller Tempo) + Stigning (m+) + Nedf√∂r (m-)</b>.
            Tempo-f√§lten konverteras direkt och synkas med flik 1.
          </p>

          <div class="row7">
            <div>
              <label for="gapPace">Tempo (min/km)</label>
              <input id="gapPace" inputmode="text" placeholder="5:00" />
            </div>
            <div>
              <label for="gapKmh">Tempo (km/h)</label>
              <input id="gapKmh" inputmode="decimal" placeholder="12.0" />
            </div>
            <div>
              <label for="gapMph">Tempo (mph)</label>
              <input id="gapMph" inputmode="decimal" placeholder="7.5" />
            </div>
            <div>
              <label for="gapDistance">Distans (km)</label>
              <input id="gapDistance" inputmode="decimal" placeholder="21.0975" />
            </div>
            <div>
              <label for="gapTime">Tid</label>
              <input id="gapTime" inputmode="text" placeholder="1:45:00" />
            </div>
            <div>
              <label for="gapUp">Stigning (m+)</label>
              <input id="gapUp" inputmode="decimal" placeholder="350" />
            </div>
            <div>
              <label for="gapDown">Nedf√∂r (m-)</label>
              <input id="gapDown" inputmode="decimal" placeholder="350" />
            </div>
          </div>

          <div class="actions">
            <button id="gapClearBtn" type="button">Rensa</button>
            <button id="gapDemoBtn" type="button">Demo</button>
          </div>

          <div class="status" id="statusGap">Fyll i distans + (tid eller tempo). m+/m- valfritt men p√•verkar GAP.</div>

          <div class="note">
            GAP h√§r √§r en <b>approximation</b> (√∂ppen modell). Med bara totalsummor m+/m- antar vi en f√∂renklad profil,
            s√• den kan skilja sig fr√•n t.ex. Strava.
          </div>
        </div>

        <div class="card">
          <h3>GAP ‚Äî resultat</h3>

          <div class="resultGrid">
            <div class="metric">
              <h4>GAP tempo (min/km)</h4>
              <div class="big" id="gapOutPace">‚Äî</div>
            </div>
            <div class="metric">
              <h4>GAP hastighet</h4>
              <div class="big" id="gapOutSpeed">‚Äî</div>
            </div>
          </div>

          <div class="list">
            <div class="listRow"><span>Flat ekv. tid (samma distans)</span><span id="gapFlatTime">‚Äî</span></div>
            <div class="listRow"><span>Aktuell tempo</span><span id="gapActualPace">‚Äî</span></div>
            <div class="listRow"><span>Antagen kostnadsfaktor</span><span id="gapFactor">‚Äî</span></div>
          </div>
        </div>
      </section>
    </div>

    <script>
      // -----------------------------
      // Gemensamma helpers
      // -----------------------------
      const KM_PER_MILE = 1.609344;

      function setText(el, txt) { el.textContent = txt; }

      function debounce(fn, waitMs) {
        let t = null;
        return function (...args) {
          if (t) clearTimeout(t);
          t = setTimeout(() => fn.apply(this, args), waitMs);
        };
      }

      function parseNumber(text) {
        // till√•ter "10", "10.5", "10,5", samt "10km" -> 10
        const t0 = String(text || "").trim();
        if (!t0) return null;
        const m = t0.replace(",", ".").match(/-?\d+(\.\d+)?/);
        if (!m) return null;
        const n = Number(m[0]);
        if (!isFinite(n) || n <= 0) return null;
        return n;
      }

      // Tempo: mm:ss eller "5.30" eller "5"
      function parsePace(text) {
        const t = String(text || "").trim();
        if (!t) return null;

        if (t.includes(".") && !t.includes(":")) {
          const [m, s] = t.split(".");
          const mm = Number(m);
          const ss = Number(s);
          if (!isFinite(mm) || !isFinite(ss) || mm < 0 || ss < 0 || ss >= 60) return null;
          const val = mm + ss / 60;
          return val > 0 ? val : null;
        }

        if (!t.includes(":")) {
          const mm = Number(t.replace(",", "."));
          if (!isFinite(mm) || mm <= 0) return null;
          return mm;
        }

        const parts = t.split(":").map(p => p.trim());
        if (parts.length !== 2) return null;

        const mm = Number(parts[0]);
        const ss = Number(parts[1]);
        if (!isFinite(mm) || !isFinite(ss) || mm < 0 || ss < 0 || ss >= 60) return null;

        const val = mm + ss / 60;
        return val > 0 ? val : null;
      }

      // Tid: mm:ss eller hh:mm:ss -> sekunder
      function parseTimeToSeconds(text) {
        const t = String(text || "").trim();
        if (!t) return null;

        const parts = t.split(":").map(p => p.trim());
        if (parts.length !== 2 && parts.length !== 3) return null;

        const nums = parts.map(x => Number(x));
        if (nums.some(n => !isFinite(n) || n < 0)) return null;

        let h = 0, m = 0, s = 0;
        if (parts.length === 2) { m = nums[0]; s = nums[1]; }
        else { h = nums[0]; m = nums[1]; s = nums[2]; }

        if (m >= 60 || s >= 60) return null;

        const total = Math.round(h * 3600 + m * 60 + s);
        return total > 0 ? total : null;
      }

      function formatPace(minPerKm) {
        if (!isFinite(minPerKm) || minPerKm <= 0) return "‚Äî";
        let mm = Math.floor(minPerKm);
        let ss = Math.round((minPerKm - mm) * 60);
        if (ss === 60) { ss = 0; mm += 1; }
        return `${mm}:${String(ss).padStart(2, "0")}`;
      }

      function formatTimeFromSeconds(totalSeconds) {
        if (!isFinite(totalSeconds) || totalSeconds <= 0) return "‚Äî";
        const sec = Math.round(totalSeconds);
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = sec % 60;
        if (h > 0) return `${h}:${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
        return `${m}:${String(s).padStart(2, "0")}`;
      }

      function clamp(n, lo, hi) { return Math.min(hi, Math.max(lo, n)); }

      function paceToKmh(paceMinPerKm) {
        if (!paceMinPerKm || paceMinPerKm <= 0) return null;
        return 60 / paceMinPerKm;
      }

      function paceToMph(paceMinPerKm) {
        const kmh = paceToKmh(paceMinPerKm);
        if (!kmh) return null;
        return kmh / KM_PER_MILE;
      }

      function kmhToPace(kmh) {
        if (!kmh || kmh <= 0) return null;
        return 60 / kmh;
      }

      function mphToPace(mph) {
        if (!mph || mph <= 0) return null;
        return 60 / (mph * KM_PER_MILE);
      }

      // -----------------------------
      // Tabs
      // -----------------------------
      const tabCalc = document.getElementById("tabCalc");
      const tabGap = document.getElementById("tabGap");
      const panelCalc = document.getElementById("panelCalc");
      const panelGap = document.getElementById("panelGap");

      function setTab(which) {
        const isCalc = which === "calc";
        tabCalc.setAttribute("aria-selected", String(isCalc));
        tabGap.setAttribute("aria-selected", String(!isCalc));
        panelCalc.classList.toggle("hidden", !isCalc);
        panelGap.classList.toggle("hidden", isCalc);
      }
      tabCalc.addEventListener("click", () => setTab("calc"));
      tabGap.addEventListener("click", () => setTab("gap"));

      // -----------------------------
      // Tv√• "forms" som delar tempo-state + synk
      // -----------------------------
      const calc = {
        pace: document.getElementById("pace"),
        kmh: document.getElementById("kmh"),
        mph: document.getElementById("mph"),
        distance: document.getElementById("distance"),
        time: document.getElementById("time"),
        clearBtn: document.getElementById("clearBtn"),
        demoBtn: document.getElementById("demoBtn"),
        status: document.getElementById("statusCalc"),
        outSpeed: document.getElementById("outSpeed"),
        outPace: document.getElementById("outPace"),
        outExtra: document.getElementById("outExtra"),
        t5k: document.getElementById("t5k"),
        t10k: document.getElementById("t10k"),
        thm: document.getElementById("thm"),
        tm: document.getElementById("tm"),
      };

      const gap = {
        pace: document.getElementById("gapPace"),
        kmh: document.getElementById("gapKmh"),
        mph: document.getElementById("gapMph"),
        distance: document.getElementById("gapDistance"),
        time: document.getElementById("gapTime"),
        up: document.getElementById("gapUp"),
        down: document.getElementById("gapDown"),
        clearBtn: document.getElementById("gapClearBtn"),
        demoBtn: document.getElementById("gapDemoBtn"),
        status: document.getElementById("statusGap"),
        outPace: document.getElementById("gapOutPace"),
        outSpeed: document.getElementById("gapOutSpeed"),
        flatTime: document.getElementById("gapFlatTime"),
        actualPace: document.getElementById("gapActualPace"),
        factor: document.getElementById("gapFactor"),
      };

      // Auto-flaggor per form (f√∂r "sn√§ll sync")
      let calcIsFilling = false;
      let calcLastEdited = null;
      let calcAuto = { pace: false, kmh: false, mph: false, distance: false, time: false };

      let gapIsFilling = false;
      let gapLastEdited = null;
      let gapAuto = { pace: false, kmh: false, mph: false, distance: false, time: false, up: false, down: false };

      function shouldWriteField(el, autoFlag) {
        const empty = String(el.value || "").trim() === "";
        return empty || autoFlag === true;
      }

      // -------- Tempo sync (tv√•v√§gs) --------
      function applyTempoToForm(form, autoFlags, isFillingSetter, paceMinPerKm, sourceEl) {
        const pStr = paceMinPerKm ? formatPace(paceMinPerKm) : "";
        const kmh = paceMinPerKm ? paceToKmh(paceMinPerKm) : null;
        const mph = paceMinPerKm ? paceToMph(paceMinPerKm) : null;

        // vi skriver inte √∂ver f√§ltet som user just skrev i (sourceEl)
        const write = (key, value) => {
          const el = form[key];
          if (!el) return;
          if (el === sourceEl) return;
          if (!shouldWriteField(el, autoFlags[key])) return;

          isFillingSetter(true);
          el.value = value;
          isFillingSetter(false);
          autoFlags[key] = true;
        };

        if (paceMinPerKm) {
          write("pace", pStr);
          write("kmh", kmh ? kmh.toFixed(1) : "");
          write("mph", mph ? mph.toFixed(1) : "");
        } else {
          // om paceMinPerKm √§r null, g√∂r inget (vi vill inte t√∂mma andras inputs)
        }
      }

      function syncTempoAcrossTabs(paceMinPerKm, sourceFormName, sourceEl) {
        if (!paceMinPerKm) return;

        if (sourceFormName === "calc") {
          applyTempoToForm(gap, gapAuto, (v) => (gapIsFilling = v), paceMinPerKm, null);
        } else {
          applyTempoToForm(calc, calcAuto, (v) => (calcIsFilling = v), paceMinPerKm, null);
        }
      }

      function getPaceFromTempoFields(form, lastEditedEl) {
        const p = parsePace(form.pace.value);
        const k = parseNumber(form.kmh.value);
        const m = parseNumber(form.mph.value);

        if (lastEditedEl === form.pace && p) return p;
        if (lastEditedEl === form.kmh && k) return kmhToPace(k);
        if (lastEditedEl === form.mph && m) return mphToPace(m);

        // fallback: f√∂rsta giltiga
        if (p) return p;
        if (k) return kmhToPace(k);
        if (m) return mphToPace(m);
        return null;
      }

      // -----------------------------
      // Flik 1: Ber√§kningar
      // -----------------------------
      function calcSetStatus(msg) { setText(calc.status, msg); }

      function calcClearOutputs() {
        setText(calc.outSpeed, "‚Äî");
        setText(calc.outPace, "‚Äî");
        setText(calc.outExtra, "‚Äî");
        setText(calc.t5k, "‚Äî");
        setText(calc.t10k, "‚Äî");
        setText(calc.thm, "‚Äî");
        setText(calc.tm, "‚Äî");
      }

      function calcRender(paceMinPerKm, distanceKm, timeSec, label) {
        const kmh = paceMinPerKm ? paceToKmh(paceMinPerKm) : null;

        setText(calc.outPace, paceMinPerKm ? `${formatPace(paceMinPerKm)} min/km` : "‚Äî");
        setText(calc.outSpeed, kmh ? `${kmh.toFixed(1)} km/h` : "‚Äî");

        if (paceMinPerKm) {
          const paceSecPerKm = paceMinPerKm * 60;
          setText(calc.t5k, formatTimeFromSeconds(paceSecPerKm * 5));
          setText(calc.t10k, formatTimeFromSeconds(paceSecPerKm * 10));
          setText(calc.thm, formatTimeFromSeconds(paceSecPerKm * 21.0975));
          setText(calc.tm, formatTimeFromSeconds(paceSecPerKm * 42.195));
        } else {
          setText(calc.t5k, "‚Äî");
          setText(calc.t10k, "‚Äî");
          setText(calc.thm, "‚Äî");
          setText(calc.tm, "‚Äî");
        }

        const parts = [];
        if (paceMinPerKm) parts.push(`${formatPace(paceMinPerKm)} min/km`);
        if (kmh) parts.push(`${kmh.toFixed(1)} km/h`);
        if (distanceKm) parts.push(`${distanceKm} km`);
        if (timeSec) parts.push(`${formatTimeFromSeconds(timeSec)}`);
        setText(calc.outExtra, parts.length ? `Baserat p√•: ${parts.join(" ‚Ä¢ ")}` : "‚Äî");

        calcSetStatus(label || "Klart ‚úÖ");
      }

      function calcFillField(key, value) {
        const el = calc[key];
        if (!el) return;
        if (!shouldWriteField(el, calcAuto[key])) return;

        calcIsFilling = true;
        el.value = value;
        calcIsFilling = false;
        calcAuto[key] = true;
      }

      function calcComputeNow() {
        if (calcIsFilling) return;

        // 1) tempo (kan r√§cka f√∂r att auto-fylla tempo-f√§lten + synk)
        const paceMinPerKm = getPaceFromTempoFields(calc, calcLastEdited);

        // alltid: om vi har tempo -> fyll tempo-varianter direkt + synka GAP-fliken
        if (paceMinPerKm) {
          applyTempoToForm(calc, calcAuto, (v) => (calcIsFilling = v), paceMinPerKm, calcLastEdited);
          syncTempoAcrossTabs(paceMinPerKm, "calc", calcLastEdited);
        }

        // 2) distans/tid ber√§kning
        const distanceKm = parseNumber(calc.distance.value);
        const timeSec = parseTimeToSeconds(calc.time.value);

        const hasP = !!paceMinPerKm;
        const hasD = !!distanceKm;
        const hasT = !!timeSec;

        // Om bara tempo √§r ifyllt -> rendera bara tempo/hastighet (ingen distans/tid)
        if (hasP && !hasD && !hasT) {
          calcRender(paceMinPerKm, null, null, "Konverterade tempo (ingen distans/tid angiven)");
          return;
        }

        // Om distans + tid -> r√§kna tempo
        if (hasD && hasT) {
          const p = (timeSec / 60) / distanceKm;
          applyTempoToForm(calc, calcAuto, (v) => (calcIsFilling = v), p, null);
          syncTempoAcrossTabs(p, "calc", null);
          calcRender(p, distanceKm, timeSec, "R√§knade ut tempo (distans + tid)");
          return;
        }

        // Om tempo + distans -> r√§kna tid
        if (hasP && hasD && !hasT) {
          const t = Math.round(paceMinPerKm * 60 * distanceKm);
          calcFillField("time", formatTimeFromSeconds(t));
          calcRender(paceMinPerKm, distanceKm, t, "R√§knade ut tid (tempo + distans)");
          return;
        }

        // Om tempo + tid -> r√§kna distans
        if (hasP && hasT && !hasD) {
          const d = (timeSec / 60) / paceMinPerKm;
          const dStr = (d >= 10 ? d.toFixed(2) : d.toFixed(3)).replace(".", ",");
          calcFillField("distance", dStr);
          calcRender(paceMinPerKm, d, timeSec, "R√§knade ut distans (tempo + tid)");
          return;
        }

        // Om tempo + distans + tid -> bara rendera (stabilt)
        if (hasP && hasD && hasT) {
          calcRender(paceMinPerKm, distanceKm, timeSec, "Uppdaterat");
          return;
        }

        // Om distans eller tid ensamt -> inget att g√∂ra √§n
        calcClearOutputs();
        calcSetStatus("Fyll i tempo (valfri enhet) eller distans + tid.");
      }

      const calcCompute = debounce(calcComputeNow, 200);

      function calcOnUserInput(el) {
        if (calcIsFilling) return;
        calcLastEdited = el;

        // anv√§ndar-typed => inte auto l√§ngre
        if (el === calc.pace) calcAuto.pace = false;
        if (el === calc.kmh) calcAuto.kmh = false;
        if (el === calc.mph) calcAuto.mph = false;
        if (el === calc.distance) calcAuto.distance = false;
        if (el === calc.time) calcAuto.time = false;

        calcCompute();
      }

      [calc.pace, calc.kmh, calc.mph, calc.distance, calc.time].forEach((el) => {
        el.addEventListener("input", () => calcOnUserInput(el));
      });

      calc.clearBtn.addEventListener("click", () => {
        calcIsFilling = true;
        calc.pace.value = "";
        calc.kmh.value = "";
        calc.mph.value = "";
        calc.distance.value = "";
        calc.time.value = "";
        calcIsFilling = false;

        calcAuto = { pace: false, kmh: false, mph: false, distance: false, time: false };
        calcLastEdited = null;
        calcClearOutputs();
        calcSetStatus("Rensat. Skriv tempo eller distans + tid.");
      });

      calc.demoBtn.addEventListener("click", () => {
        calcIsFilling = true;
        calc.pace.value = "5:30";
        calc.kmh.value = "";
        calc.mph.value = "";
        calc.distance.value = "10";
        calc.time.value = "";
        calcIsFilling = false;

        calcAuto = { pace: false, kmh: true, mph: true, distance: false, time: true };
        calcLastEdited = calc.distance;
        calcComputeNow();
      });

      // -----------------------------
      // Flik 2: GAP (variant B) + tempo inputs
      // -----------------------------
      function gapSetStatus(msg) { setText(gap.status, msg); }

      // Minetti-inspirerad energikostnadsfunktion (J/kg/m) som funktion av slope g (t.ex. 0.05 = 5%)
      function minettiCost(g) {
        const x = clamp(g, -0.30, 0.30);
        return 155.4*Math.pow(x,5) - 30.4*Math.pow(x,4) - 43.3*Math.pow(x,3) + 46.3*Math.pow(x,2) + 19.5*x + 3.6;
      }

      function gapClearOutputs() {
        setText(gap.outPace, "‚Äî");
        setText(gap.outSpeed, "‚Äî");
        setText(gap.flatTime, "‚Äî");
        setText(gap.actualPace, "‚Äî");
        setText(gap.factor, "‚Äî");
      }

      function gapFillField(key, value) {
        const el = gap[key];
        if (!el) return;
        if (!shouldWriteField(el, gapAuto[key])) return;

        gapIsFilling = true;
        el.value = value;
        gapIsFilling = false;
        gapAuto[key] = true;
      }

      function gapComputeNow() {
        if (gapIsFilling) return;

        // tempo (valfritt) -> kan r√§cka f√∂r konvertering + synk, √§ven utan dist/tid
        const paceMinPerKm = getPaceFromTempoFields(gap, gapLastEdited);
        if (paceMinPerKm) {
          applyTempoToForm(gap, gapAuto, (v) => (gapIsFilling = v), paceMinPerKm, gapLastEdited);
          syncTempoAcrossTabs(paceMinPerKm, "gap", gapLastEdited);
        }

        const distKm = parseNumber(gap.distance.value);
        const timeSec = parseTimeToSeconds(gap.time.value);
        const upM = parseNumber(gap.up.value) || 0;
        const downM = parseNumber(gap.down.value) || 0;

        // Om vi har dist + tempo men saknar tid -> r√§kna ut tid
        if (distKm && paceMinPerKm && !timeSec) {
          const t = Math.round(paceMinPerKm * 60 * distKm);
          gapFillField("time", formatTimeFromSeconds(t));
        }

        // Om vi har dist + tid men saknar tempo -> r√§kna tempo
        const timeSec2 = parseTimeToSeconds(gap.time.value); // efter ev. autofill
        const hasD = !!distKm;
        const hasT = !!timeSec2;
        const hasP = !!paceMinPerKm || (hasD && hasT);

        let actualPaceSecPerKm = null;

        if (hasD && hasT) {
          actualPaceSecPerKm = timeSec2 / distKm;
        } else if (hasD && paceMinPerKm) {
          actualPaceSecPerKm = (paceMinPerKm * 60);
        }

        // Om vi bara har tempo och inget dist -> vi kan inte anv√§nda m+/m- men vi kan visa tempo-konvertering
        if (paceMinPerKm && !hasD) {
          gapClearOutputs();
          gapSetStatus("Konverterade tempo. L√§gg till distans (och ev. m+/m-) f√∂r GAP.");
          setText(gap.actualPace, `${formatPace(paceMinPerKm)} min/km`);
          setText(gap.factor, "‚Äî");
          return;
        }

        // Om vi har dist men varken tid eller tempo -> inget att g√∂ra
        if (hasD && !actualPaceSecPerKm) {
          gapClearOutputs();
          gapSetStatus("Fyll i tempo eller tid (distans finns).");
          return;
        }

        // Om vi saknar dist -> inget GAP
        if (!hasD || !actualPaceSecPerKm) {
          gapClearOutputs();
          gapSetStatus("Fyll i distans + (tid eller tempo).");
          return;
        }

        const actualPaceMinPerKm2 = actualPaceSecPerKm / 60;

        // grade approx fr√•n totalsummor
        const gUp = upM > 0 ? (upM / (distKm * 1000)) : 0;
        const gDown = downM > 0 ? (-downM / (distKm * 1000)) : 0;

        const c0 = minettiCost(0);

        let cAvg;
        if (upM > 0 && downM > 0) cAvg = (minettiCost(gUp) + minettiCost(gDown) + c0) / 3;
        else if (upM > 0) cAvg = (minettiCost(gUp) + c0) / 2;
        else if (downM > 0) cAvg = (minettiCost(gDown) + c0) / 2;
        else cAvg = c0;

        const factor = cAvg / c0;

        const gapPaceSecPerKm = actualPaceSecPerKm / factor;
        const gapPaceMinPerKm = gapPaceSecPerKm / 60;
        const gapKmh = 3600 / gapPaceSecPerKm;

        const flatEquivalentTimeSec = Math.round(gapPaceSecPerKm * distKm);

        setText(gap.actualPace, `${formatPace(actualPaceMinPerKm2)} min/km`);
        setText(gap.factor, `${factor.toFixed(3)}√ó`);
        setText(gap.outPace, `${formatPace(gapPaceMinPerKm)} min/km`);
        setText(gap.outSpeed, `${gapKmh.toFixed(1)} km/h`);
        setText(gap.flatTime, formatTimeFromSeconds(flatEquivalentTimeSec));

        gapSetStatus("Klart ‚úÖ");
      }

      const gapCompute = debounce(gapComputeNow, 200);

      function gapOnUserInput(el) {
        if (gapIsFilling) return;
        gapLastEdited = el;

        if (el === gap.pace) gapAuto.pace = false;
        if (el === gap.kmh) gapAuto.kmh = false;
        if (el === gap.mph) gapAuto.mph = false;
        if (el === gap.distance) gapAuto.distance = false;
        if (el === gap.time) gapAuto.time = false;
        if (el === gap.up) gapAuto.up = false;
        if (el === gap.down) gapAuto.down = false;

        gapCompute();
      }

      [gap.pace, gap.kmh, gap.mph, gap.distance, gap.time, gap.up, gap.down].forEach((el) => {
        el.addEventListener("input", () => gapOnUserInput(el));
      });

      gap.clearBtn.addEventListener("click", () => {
        gapIsFilling = true;
        gap.pace.value = "";
        gap.kmh.value = "";
        gap.mph.value = "";
        gap.distance.value = "";
        gap.time.value = "";
        gap.up.value = "";
        gap.down.value = "";
        gapIsFilling = false;

        gapAuto = { pace: false, kmh: false, mph: false, distance: false, time: false, up: false, down: false };
        gapLastEdited = null;
        gapClearOutputs();
        gapSetStatus("Rensat. Fyll i distans + (tid eller tempo).");
      });

      gap.demoBtn.addEventListener("click", () => {
        gapIsFilling = true;
        gap.pace.value = "5:00";
        gap.kmh.value = "";
        gap.mph.value = "";
        gap.distance.value = "21.0975";
        gap.time.value = "";
        gap.up.value = "350";
        gap.down.value = "350";
        gapIsFilling = false;

        gapAuto = { pace: false, kmh: true, mph: true, distance: false, time: true, up: false, down: false };
        gapLastEdited = gap.distance;
        gapComputeNow();
      });

      // init
      calcClearOutputs();
      calcSetStatus("B√∂rja med att skriva tempo (valfri enhet) eller distans + tid.");
      gapClearOutputs();
      gapSetStatus("Fyll i distans + (tid eller tempo). m+/m- p√•verkar GAP.");

    </script>
  </body>
</html>
